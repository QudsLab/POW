name: Build Multi-Platform Binaries

permissions:
  contents: write

on:
  push:
    branches: [main, master, develop]
    paths:
      - "src/**"
      - "Makefile"
      - "build_*.sh"
      - "generate_manifest.py"
      - ".github/workflows/**"
  pull_request:
    branches: [main, master]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0" # Weekly build every Sunday

env:
  BUILD_VERSION: ${{ github.run_number }}
  REPO: qudslab/pow

jobs:
  # Windows 32-bit
  build-windows-32:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-make
            make

      - name: Build Windows 32-bit
        shell: msys2 {0}
        run: |
          make clean-obj
          CFLAGS="-w -O2 -std=c99 -fPIC -m32" CXXFLAGS="-w -O2 -std=c++11 -fPIC -m32" make all 2>/dev/null || echo "32-bit build attempted"
          mkdir -p bin/windows/32
          cp bin/*.dll bin/windows/32/ 2>/dev/null || echo "No DLLs found"
          ls -lh bin/windows/32/

      - name: Commit Windows 32-bit
        shell: msys2 {0}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add bin/windows/32/
          if ! git diff --staged --quiet; then
            git commit -m "Build v${{ env.BUILD_VERSION }}: Windows 32-bit binaries [skip ci]"
            git pull --rebase origin main || git pull --rebase origin master || true
            git push origin HEAD:main || git push origin HEAD:master || git push
          fi

  # Windows 64-bit
  build-windows-64:
    runs-on: windows-latest
    needs: build-windows-32
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-make
            make

      - name: Build Windows 64-bit
        shell: msys2 {0}
        run: |
          make clean-obj
          make all
          mkdir -p bin/windows/64
          cp bin/*.dll bin/windows/64/ 2>/dev/null || echo "No DLLs found"
          ls -lh bin/windows/64/

      - name: Commit Windows 64-bit
        shell: msys2 {0}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add bin/windows/64/
          if ! git diff --staged --quiet; then
            git commit -m "Build v${{ env.BUILD_VERSION }}: Windows 64-bit binaries [skip ci]"
            git pull --rebase origin main || git pull --rebase origin master || true
            git push origin HEAD:main || git push origin HEAD:master || git push
          fi

  # Linux 32-bit
  build-linux-32:
    runs-on: ubuntu-latest
    needs: build-windows-64
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib g++-multilib

      - name: Build Linux 32-bit
        run: |
          make clean-obj
          CFLAGS="-w -O2 -std=c99 -fPIC -m32" CXXFLAGS="-w -O2 -std=c++11 -fPIC -m32" make all 2>/dev/null || echo "32-bit build attempted"
          mkdir -p bin/linux/32
          cp bin/*.so bin/linux/32/ 2>/dev/null || echo "No .so files found"
          ls -lh bin/linux/32/

      - name: Commit Linux 32-bit
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add bin/linux/32/
          if ! git diff --staged --quiet; then
            git commit -m "Build v${{ env.BUILD_VERSION }}: Linux 32-bit binaries [skip ci]"
            git pull --rebase origin main || git pull --rebase origin master || true
            git push origin HEAD:main || git push origin HEAD:master || git push
          fi

  # Linux 64-bit
  build-linux-64:
    runs-on: ubuntu-latest
    needs: build-linux-32
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Build Linux 64-bit
        run: |
          make clean-obj
          make all
          mkdir -p bin/linux/64
          cp bin/*.so bin/linux/64/ 2>/dev/null || echo "No .so files found"
          ls -lh bin/linux/64/

      - name: Commit Linux 64-bit
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add bin/linux/64/
          if ! git diff --staged --quiet; then
            git commit -m "Build v${{ env.BUILD_VERSION }}: Linux 64-bit binaries [skip ci]"
            git pull --rebase origin main || git pull --rebase origin master || true
            git push origin HEAD:main || git push origin HEAD:master || git push
          fi

  # macOS 64-bit
  build-macos-64:
    runs-on: macos-latest
    needs: build-linux-64
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build macOS 64-bit
        run: |
          make clean-obj
          make all
          mkdir -p bin/macos/64
          cp bin/*.dylib bin/macos/64/ 2>/dev/null || echo "No .dylib files found"
          ls -lh bin/macos/64/

      - name: Commit macOS 64-bit
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add bin/macos/64/
          if ! git diff --staged --quiet; then
            git commit -m "Build v${{ env.BUILD_VERSION }}: macOS 64-bit binaries [skip ci]"
            git pull --rebase origin main || git pull --rebase origin master || true
            git push origin HEAD:main || git push origin HEAD:master || git push
          fi

  # Android 32-bit
  build-android-32:
    runs-on: ubuntu-latest
    needs: build-macos-64
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b

      - name: Build Android 32-bit
        run: |
          make clean-obj
          CFLAGS="-w -O2 -std=c99 -fPIC -m32" CXXFLAGS="-w -O2 -std=c++11 -fPIC -m32" make all 2>/dev/null || echo "32-bit build attempted"
          mkdir -p bin/android/32
          cp bin/*.so bin/android/32/ 2>/dev/null || echo "No .so files found"
          ls -lh bin/android/32/

      - name: Commit Android 32-bit
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add bin/android/32/
          if ! git diff --staged --quiet; then
            git commit -m "Build v${{ env.BUILD_VERSION }}: Android 32-bit binaries [skip ci]"
            git pull --rebase origin main || git pull --rebase origin master || true
            git push origin HEAD:main || git push origin HEAD:master || git push
          fi

  # Android 64-bit
  build-android-64:
    runs-on: ubuntu-latest
    needs: build-android-32
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b

      - name: Build Android 64-bit
        run: |
          make clean-obj
          make all
          mkdir -p bin/android/64
          cp bin/*.so bin/android/64/ 2>/dev/null || echo "No .so files found"
          ls -lh bin/android/64/

      - name: Commit Android 64-bit
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add bin/android/64/
          if ! git diff --staged --quiet; then
            git commit -m "Build v${{ env.BUILD_VERSION }}: Android 64-bit binaries [skip ci]"
            git pull --rebase origin main || git pull --rebase origin master || true
            git push origin HEAD:main || git push origin HEAD:master || git push
          fi

  # WASM 32-bit
  build-wasm-32:
    runs-on: ubuntu-latest
    needs: build-android-64
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: latest

      - name: Build WASM 32-bit
        run: |
          make clean-obj
          CC=emcc CXX=em++ make all 2>/dev/null || echo "Emscripten build attempted"
          mkdir -p bin/wasm/32
          cp bin/*.wasm bin/wasm/32/ 2>/dev/null || echo "No .wasm files found"
          cp bin/*.js bin/wasm/32/ 2>/dev/null || true
          ls -lh bin/wasm/32/ || echo "Directory empty"

      - name: Commit WASM 32-bit
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add bin/wasm/32/
          if ! git diff --staged --quiet; then
            git commit -m "Build v${{ env.BUILD_VERSION }}: WASM 32-bit binaries [skip ci]"
            git pull --rebase origin main || git pull --rebase origin master || true
            git push origin HEAD:main || git push origin HEAD:master || git push
          fi

  # WASM 64-bit
  build-wasm-64:
    runs-on: ubuntu-latest
    needs: build-wasm-32
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: latest

      - name: Build WASM 64-bit
        run: |
          make clean-obj
          CC=emcc CXX=em++ make all 2>/dev/null || echo "Emscripten build attempted"
          mkdir -p bin/wasm/64
          cp bin/*.wasm bin/wasm/64/ 2>/dev/null || echo "No .wasm files found"
          cp bin/*.js bin/wasm/64/ 2>/dev/null || true
          ls -lh bin/wasm/64/ || echo "Directory empty"

      - name: Commit WASM 64-bit
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add bin/wasm/64/
          if ! git diff --staged --quiet; then
            git commit -m "Build v${{ env.BUILD_VERSION }}: WASM 64-bit binaries [skip ci]"
            git pull --rebase origin main || git pull --rebase origin master || true
            git push origin HEAD:main || git push origin HEAD:master || git push
          fi

  # Generate versions.json
  generate-manifest:
    runs-on: ubuntu-latest
    needs: build-wasm-64
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate versions.json
        run: |
          echo "=== Current bin structure ==="
          find bin -type f -ls || echo "No binaries found"

          echo ""
          echo "=== Generating versions.json ==="
          python3 generate_manifest.py bin bin/versions.json
          cp BINARY_INFO.md bin/BINARY_INFO.md

          echo ""
          echo "=== versions.json content ==="
          cat bin/versions.json

      - name: Commit versions.json
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add bin/versions.json bin/BINARY_INFO.md
          if ! git diff --staged --quiet; then
            git commit -m "Build v${{ env.BUILD_VERSION }}: Update versions.json [skip ci]"
            git pull --rebase origin main || git pull --rebase origin master || true
            git push origin HEAD:main || git push origin HEAD:master || git push
          fi
