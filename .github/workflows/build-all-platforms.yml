name: Build Multi-Platform Binaries

permissions:
  contents: write

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'src/**'
      - 'Makefile'
      - 'build_*.sh'
      - 'generate_manifest.py'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly build every Sunday

env:
  BUILD_VERSION: ${{ github.run_number }}
  REPO: qudslab/pow
  RELEASE_URL: https://github.com/qudslab/pow/releases/download/v${{ github.run_number }}

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-make
            make
      
      - name: Build Windows Binaries
        shell: msys2 {0}
        run: |
          chmod +x build_windows.sh
          bash build_windows.sh
      
      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: bin/windows/
          retention-days: 90

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib g++-multilib
      
      - name: Build Linux Binaries
        run: |
          chmod +x build_linux.sh
          bash build_linux.sh
      
      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: bin/linux/
          retention-days: 90

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build macOS Binaries
        run: |
          chmod +x build_macos.sh
          bash build_macos.sh
      
      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: bin/macos/
          retention-days: 90

  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b
      
      - name: Build Android Binaries
        run: |
          chmod +x build_android.sh
          bash build_android.sh
      
      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-binaries
          path: bin/android/
          retention-days: 90

  build-wasm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: latest
      
      - name: Build WebAssembly Binaries
        run: |
          chmod +x build_wasm.sh
          bash build_wasm.sh
      
      - name: Upload WASM Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-binaries
          path: bin/wasm/
          retention-days: 90

  commit-binaries:
    needs: [build-windows, build-linux, build-macos, build-android, build-wasm]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts
      
      - name: Organize binaries
        run: |
          echo "Downloaded artifacts:"
          ls -laR downloaded-artifacts/
          
          mkdir -p bin
          
          # Artifacts are downloaded as: downloaded-artifacts/{platform}-binaries/{32|64}/files
          # We need: bin/{platform}/{32|64}/files
          
          if [ -d "downloaded-artifacts/windows-binaries" ]; then
            mkdir -p bin/windows
            cp -rv downloaded-artifacts/windows-binaries/* bin/windows/
          fi
          
          if [ -d "downloaded-artifacts/linux-binaries" ]; then
            mkdir -p bin/linux
            cp -rv downloaded-artifacts/linux-binaries/* bin/linux/
          fi
          
          if [ -d "downloaded-artifacts/macos-binaries" ]; then
            mkdir -p bin/macos
            cp -rv downloaded-artifacts/macos-binaries/* bin/macos/
          fi
          
          if [ -d "downloaded-artifacts/android-binaries" ]; then
            mkdir -p bin/android
            cp -rv downloaded-artifacts/android-binaries/* bin/android/
          fi
          
          if [ -d "downloaded-artifacts/wasm-binaries" ]; then
            mkdir -p bin/wasm
            cp -rv downloaded-artifacts/wasm-binaries/* bin/wasm/
          fi
          
          echo "Final bin structure:"
          find bin -type f -ls
      
      - name: Generate versions.json
        run: |
          python3 generate_manifest.py bin bin/versions.json
          cp BINARY_INFO.md bin/BINARY_INFO.md
          cat bin/versions.json
      
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: Commit and push
        run: |
          git add bin/
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "Build v${{ env.BUILD_VERSION }}: Update binaries [skip ci]"
            git pull --no-rebase origin main || true
            git push origin main || git push
          fi
