name: Build Multi-Platform Binaries

permissions:
  contents: write

on:
  push:
    branches: [main, master, develop]
    paths:
      - "src/**"
      - "Makefile"
      - "builder.py"
      - "generate_manifest.py"
      - ".github/workflows/**"
  pull_request:
    branches: [main, master]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0" # Weekly build every Sunday

env:
  BUILD_VERSION: ${{ github.run_number }}

jobs:
  # ========== WINDOWS BUILDS ==========
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-make
            mingw-w64-ucrt-x86_64-python
            make

      - name: Build Windows binaries (32-bit and 64-bit)
        shell: msys2 {0}
        run: |
          python3 builder.py all

      - name: Upload Windows binaries
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: bin/windows/
          retention-days: 1

  # ========== LINUX BUILDS ==========
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib g++-multilib

      - name: Build Linux binaries (32-bit and 64-bit)
        run: |
          python3 builder.py all

      - name: Upload Linux binaries
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: bin/linux/
          retention-days: 1

  # ========== MACOS BUILD ==========
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Build macOS binaries (64-bit only)
        run: |
          python3 builder.py all

      - name: Upload macOS binaries
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: bin/macos/
          retention-days: 1

  # ========== ANDROID BUILDS ==========
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b

      - name: Build Android binaries (32-bit and 64-bit)
        run: |
          python3 builder.py all

      - name: Upload Android binaries
        uses: actions/upload-artifact@v4
        with:
          name: android-binaries
          path: bin/android/
          retention-days: 1

  # ========== COMMIT ALL BINARIES ==========
  commit-binaries:
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux, build-macos, build-android]
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize Binaries
        run: |
          echo "=== Downloaded artifacts ==="
          ls -laR artifacts/

          echo ""
          echo "=== Organizing binaries ==="
          mkdir -p bin

          # Copy platform directories preserving structure
          # artifacts/windows-binaries/windows/ -> bin/windows/
          # artifacts/linux-binaries/linux/ -> bin/linux/
          if [ -d "artifacts/windows-binaries/windows" ]; then
            echo "Copying Windows binaries..."
            cp -rv artifacts/windows-binaries/windows bin/
          fi

          if [ -d "artifacts/linux-binaries/linux" ]; then
            echo "Copying Linux binaries..."
            cp -rv artifacts/linux-binaries/linux bin/
          fi

          if [ -d "artifacts/macos-binaries/macos" ]; then
            echo "Copying macOS binaries..."
            cp -rv artifacts/macos-binaries/macos bin/
          fi

          if [ -d "artifacts/android-binaries/android" ]; then
            echo "Copying Android binaries..."
            cp -rv artifacts/android-binaries/android bin/
          fi

          echo ""
          echo "=== Final bin structure ==="
          find bin -type f -ls 2>/dev/null || echo "No binaries found"

      - name: Generate versions.json
        run: |
          echo "=== Generating versions.json ==="
          python3 generate_manifest.py bin bin/versions.json || echo "Warning: versions.json generation failed"
          cp BINARY_INFO.md bin/BINARY_INFO.md || true

          echo ""
          echo "=== versions.json content ==="
          cat bin/versions.json || echo "No versions.json found"

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit and push binaries
        run: |
          git add bin/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # Count binaries
            binary_count=$(find bin -type f \( -name "*.dll" -o -name "*.so" -o -name "*.dylib" \) 2>/dev/null | wc -l)
            
            git commit -m "Build v${{ env.BUILD_VERSION }}: Update $binary_count binaries [skip ci]"
            
            # Pull and push with retry
            git pull --no-rebase origin main || git pull --rebase origin main || true
            
            max_retries=3
            retry_count=0
            while [ $retry_count -lt $max_retries ]; do
              if git push origin main; then
                echo "[OK] Binaries committed successfully!"
                break
              else
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                  echo "Retrying ($retry_count/$max_retries)..."
                  git pull --rebase origin main
                  sleep 2
                else
                  echo "[ERROR] Failed after $max_retries attempts"
                  exit 1
                fi
              fi
            done
          fi
