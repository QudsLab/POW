name: Build Multi-Platform Binaries

permissions:
  contents: write

on:
  push:
    branches: [main, master, develop]
    paths:
      - "src/**"
      - "Makefile"
      - "builder.py"
      - "generate_manifest.py"
      - ".github/workflows/**"
  pull_request:
    branches: [main, master]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0" # Weekly build every Sunday

env:
  BUILD_VERSION: ${{ github.run_number }}

jobs:
  # ========== WINDOWS BUILDS ==========
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-make
            mingw-w64-ucrt-x86_64-python
            make

      - name: Build Windows binaries (32-bit and 64-bit)
        shell: msys2 {0}
        run: |
          python3 builder.py all

      - name: Verify Windows binaries
        shell: bash
        run: |
          echo "=== Windows binaries structure ==="
          ls -laR bin/windows/ || echo "No binaries found"

      - name: Upload Windows binaries
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: bin/windows/**/*
          retention-days: 1
          if-no-files-found: error

  # ========== LINUX BUILDS ==========
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib g++-multilib

      - name: Build Linux binaries (32-bit and 64-bit)
        run: |
          python3 builder.py all

      - name: Verify Linux binaries
        run: |
          echo "=== Linux binaries structure ==="
          ls -laR bin/linux/ || echo "No binaries found"

      - name: Upload Linux binaries
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: bin/linux/**/*
          retention-days: 1
          if-no-files-found: error

  # ========== MACOS BUILD ==========
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build macOS binaries (64-bit only)
        run: |
          python3 builder.py all

      - name: Verify macOS binaries
        run: |
          echo "=== macOS binaries structure ==="
          ls -laR bin/macos/ || echo "No binaries found"

      - name: Upload macOS binaries
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: bin/macos/**/*
          retention-days: 1
          if-no-files-found: error

  # ========== ANDROID BUILDS ==========
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b

      - name: Build Android binaries (32-bit and 64-bit)
        run: |
          export NDK_HOME=$ANDROID_NDK_HOME
          python3 builder.py all

      - name: Verify Android binaries
        run: |
          echo "=== Android binaries structure ==="
          ls -laR bin/android/ || echo "No binaries found"

      - name: Upload Android binaries
        uses: actions/upload-artifact@v4
        with:
          name: android-binaries
          path: bin/android/**/*
          retention-days: 1
          if-no-files-found: error

  # ========== COMMIT ALL BINARIES ==========
  commit-binaries:
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux, build-macos, build-android]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Debug - Show artifact structure
        run: |
          echo "=== Complete artifact structure ==="
          find artifacts -type f -ls

      - name: Organize Binaries
        run: |
          echo "=== Creating bin directory structure ==="
          mkdir -p bin/windows bin/linux bin/macos bin/android

          # The artifacts are downloaded with structure: artifacts/{artifact-name}/{files}
          # We need to move them to: bin/{platform}/{arch}/{files}
          
          echo ""
          echo "=== Moving Windows binaries ==="
          if [ -d "artifacts/windows-binaries" ]; then
            # Check if there's a nested windows directory or direct files
            if [ -d "artifacts/windows-binaries/windows" ]; then
              cp -rv artifacts/windows-binaries/windows/* bin/windows/
            else
              cp -rv artifacts/windows-binaries/* bin/windows/
            fi
          fi

          echo ""
          echo "=== Moving Linux binaries ==="
          if [ -d "artifacts/linux-binaries" ]; then
            if [ -d "artifacts/linux-binaries/linux" ]; then
              cp -rv artifacts/linux-binaries/linux/* bin/linux/
            else
              cp -rv artifacts/linux-binaries/* bin/linux/
            fi
          fi

          echo ""
          echo "=== Moving macOS binaries ==="
          if [ -d "artifacts/macos-binaries" ]; then
            if [ -d "artifacts/macos-binaries/macos" ]; then
              cp -rv artifacts/macos-binaries/macos/* bin/macos/
            else
              cp -rv artifacts/macos-binaries/* bin/macos/
            fi
          fi

          echo ""
          echo "=== Moving Android binaries ==="
          if [ -d "artifacts/android-binaries" ]; then
            if [ -d "artifacts/android-binaries/android" ]; then
              cp -rv artifacts/android-binaries/android/* bin/android/
            else
              cp -rv artifacts/android-binaries/* bin/android/
            fi
          fi

          echo ""
          echo "=== Final bin structure ==="
          find bin -type f -ls

      - name: Generate versions.json
        run: |
          echo "=== Generating versions.json ==="
          
          if [ -f "generate_manifest.py" ]; then
            python3 generate_manifest.py bin bin/versions.json || echo "Warning: versions.json generation failed"
          else
            echo "Warning: generate_manifest.py not found, creating basic versions.json"
            echo '{"version": "'${{ env.BUILD_VERSION }}'", "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}' > bin/versions.json
          fi
          
          if [ -f "BINARY_INFO.md" ]; then
            cp BINARY_INFO.md bin/BINARY_INFO.md
          fi

          echo ""
          echo "=== versions.json content ==="
          cat bin/versions.json 2>/dev/null || echo "No versions.json created"

      - name: Verify binaries before commit
        run: |
          echo "=== Counting binaries ==="
          binary_count=$(find bin -type f \( -name "*.dll" -o -name "*.so" -o -name "*.dylib" \) 2>/dev/null | wc -l)
          echo "Found $binary_count binary files"
          
          if [ "$binary_count" -eq 0 ]; then
            echo "ERROR: No binaries found to commit!"
            exit 1
          fi
          
          echo ""
          echo "=== Binary file list ==="
          find bin -type f \( -name "*.dll" -o -name "*.so" -o -name "*.dylib" \)

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit and push binaries
        run: |
          echo "=== Checking for changes ==="
          git status
          
          echo ""
          echo "=== Adding bin directory ==="
          git add -f bin/
          
          echo ""
          echo "=== Git status after add ==="
          git status

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Count binaries
          binary_count=$(find bin -type f \( -name "*.dll" -o -name "*.so" -o -name "*.dylib" \) 2>/dev/null | wc -l)
          
          echo ""
          echo "=== Creating commit ==="
          git commit -m "Build v${{ env.BUILD_VERSION }}: Update $binary_count binaries [skip ci]"
          
          echo ""
          echo "=== Pushing to repository ==="
          max_retries=5
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            if git push origin HEAD:${{ github.ref_name }}; then
              echo ""
              echo "Binaries committed and pushed successfully!"
              exit 0
            else
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "Push failed, retrying ($retry_count/$max_retries)..."
                
                # Pull with rebase
                git pull --rebase origin ${{ github.ref_name }} || {
                  echo "Rebase failed, trying merge..."
                  git pull --no-rebase origin ${{ github.ref_name }}
                }
                
                sleep $((retry_count * 2))
              else
                echo ""
                echo "Failed to push after $max_retries attempts"
                exit 1
              fi
            fi
          done

      - name: Create summary
        if: success()
        run: |
          binary_count=$(find bin -type f \( -name "*.dll" -o -name "*.so" -o -name "*.dylib" \) 2>/dev/null | wc -l)
          
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Version:** ${{ env.BUILD_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Binaries:** $binary_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit Status:** Successfully committed and pushed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Platform Breakdown" >> $GITHUB_STEP_SUMMARY
          echo "- Windows: $(find bin/windows -type f 2>/dev/null | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- Linux: $(find bin/linux -type f 2>/dev/null | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- macOS: $(find bin/macos -type f 2>/dev/null | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- Android: $(find bin/android -type f 2>/dev/null | wc -l) files" >> $GITHUB_STEP_SUMMARY